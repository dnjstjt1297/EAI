name: PR CI & Gemini Review (Shell Only)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-ci:
    runs-on: ubuntu-latest

    steps:
      # =====================
      # Checkout (PR ë¸Œëžœì¹˜)
      # =====================
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================
      # Java 17
      # =====================
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # =====================
      # Compile
      # =====================
      - name: Compile
        run: |
          mkdir -p out
          javac -encoding UTF-8 -cp "lib/*" -d out \
            $(find src/main/java src/test/java -name "*.java")

      # =====================
      # Test
      # =====================
      - name: Run tests
        run: |
          set +e
          java -jar lib/junit-platform-console-standalone-1.8.1.jar \
            -cp out:lib/* \
            --scan-classpath > test.log 2>&1
          echo $? > test.exit
          set -e

      # =====================
      # PR diff ìƒì„±
      # =====================
      - name: Generate PR diff
        run: |
          git fetch origin "${{ github.event.pull_request.base.ref }}"
          git fetch origin "${{ github.event.pull_request.head.ref }}"

          git diff --unified=0 \
            origin/${{ github.event.pull_request.base.ref }} \
            origin/${{ github.event.pull_request.head.ref }} > diff.txt

      # =====================
      # Gemini ë¦¬ë·° (curl)
      # =====================
      - name: Gemini Code Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          DIFF=$(sed 's/"/\\"/g' diff.txt | tr '\n' '\\n')
          TEST_LOG=$(sed 's/"/\\"/g' test.log | head -c 4000 | tr '\n' '\\n')
          TEST_EXIT=$(cat test.exit)

          cat <<EOF > payload.json
          {
            "contents": [
              {
                "parts": [
                  {
                    "text": "Explain in Korean. You are a senior software engineer reviewing a pull request.\n\n1. Summarize the changes.\n2. Point out potential risks or design issues.\n3. Mention test failures if any (exit code: ${TEST_EXIT}).\n4. Suggest improvements if necessary.\n\n<git diff>\n${DIFF}\n</git diff>\n\n<test log>\n${TEST_LOG}\n</test log>"
                  }
                ]
              }
            ]
          }
          EOF

          curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -d @payload.json \
            | jq -r '.candidates[0].content.parts[0].text' > review.md

      # =====================
      # PR ì½”ë©˜íŠ¸
      # =====================
      - name: Comment PR with Gemini review
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -f body="## ðŸ¤– Gemini PR Review\n\n$(cat review.md)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
