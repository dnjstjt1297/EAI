name: PR CI & Gemini Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master] # Push 이벤트도 대응하려면 브랜치 지정 필요

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ===== 프로젝트 설정 파일 생성 =====
      - name: Create config.properties
        run: |
          mkdir -p src/main/resources src/test/resources
          cat <<EOF > src/main/resources/config.properties
          applicant.key=${{ secrets.APPLICANT_KEY }}
          db.driver=${{ secrets.DB_DRIVER }}
          db.url=${{ secrets.DB_URL }}
          db.user=${{ secrets.DB_USER }}
          db.password=${{ secrets.DB_PASSWORD }}
          sftp.host=${{ secrets.SFTP_HOST }}
          sftp.port=${{ secrets.SFTP_PORT }}
          sftp.username=${{ secrets.SFTP_USERNAME }}
          sftp.password=${{ secrets.SFTP_PASSWORD }}
          sftp.filepath=${{ secrets.SFTP_FILENAME }}
          EOF

          cat <<EOF > src/test/resources/config.properties
          applicant.key=${{ secrets.T_APPLICANT_KEY }}
          db.driver=${{ secrets.T_DB_DRIVER }}
          db.url=${{ secrets.T_DB_URL }}
          db.user=${{ secrets.T_DB_USER }}
          db.password=${{ secrets.T_DB_PASSWORD }}
          sftp.host=${{ secrets.T_SFTP_HOST }}
          sftp.port=${{ secrets.T_SFTP_PORT }}
          sftp.username=${{ secrets.T_SFTP_USERNAME }}
          sftp.password=${{ secrets.T_SFTP_PASSWORD }}
          sftp.filepath=${{ secrets.T_SFTP_FILENAME }}
          EOF

      # ===== 컴파일 및 테스트 =====
      - name: Compile
        run: |
          mkdir -p out
          javac -encoding UTF-8 -cp "lib/*" -d out \
            $(find src/main/java src/test/java -name "*.java")

      - name: Run tests
        id: test
        run: |
          set +e
          java -jar lib/junit-platform-console-standalone-1.8.1.jar \
            -cp out:lib/* \
            --scan-classpath > test.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          set -e

      # ===== Gemini AI 분석 =====
      - name: Install Gemini AI
        run: npm install @google/generative-ai

      - name: Get git diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            git diff --unified=0 origin/${{ github.event.pull_request.base.ref }} HEAD > diff.txt
            echo "EVENT_TYPE=pull_request" >> $GITHUB_ENV
          else
            git diff --unified=0 HEAD^ HEAD > diff.txt
            echo "EVENT_TYPE=push" >> $GITHUB_ENV
          fi

      - name: Run Gemini-1.5-flash
        id: gemini_review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const diff_output = fs.readFileSync("diff.txt", 'utf8');
            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const genAI = new GoogleGenerativeAI("${{ secrets.GEMINI_API_KEY }}");
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash"});
            
            let prompt;
            if (process.env.EVENT_TYPE === 'pull_request') {
              prompt = `Explain in korean. You are a senior software engineer. 
              Review the following git diff and provide feedback. 
              If you find issues, specify the file path and exact line number from the diff.
              You MUST respond ONLY with a JSON array in this format: 
              [{"path":"filepath", "line": 123, "text": "review comment", "side": "RIGHT"}]
              Do not include markdown code blocks or any other text.
            
              <git diff>
              ${diff_output}
              </git diff>`;
            } else {
              prompt = `Explain in korean. You are a senior software engineer. 
              Provide a detailed review of the code changes in Markdown format with clear headings.
            
              <git diff>
              ${diff_output}
              </git diff>`;
            }
            
            try {
              const result = await model.generateContent(prompt);
              const response = await result.response;
              let text = response.text();
            
              // JSON 응답에서 마크다운 코드 블록(```json)이 포함될 경우 제거
              if (process.env.EVENT_TYPE === 'pull_request') {
                text = text.replace(/```json|```/g, "").trim();
              }
            
              fs.writeFileSync('review_result.txt', text);
            } catch (error) {
              console.error("Gemini API Error:", error);
              process.exit(1);
            }

      # PR 이벤트: 리뷰 코멘트 등록
      - name: Add Pull Request Review Comment
        if: env.EVENT_TYPE == 'pull_request'
        uses: nbaztec/add-pr-review-comment@v1.0.7
        with:
          comments: ${{ github.workspace }}/review_result.txt
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'
          allow-repeats: false

      # Push 이벤트: 로그 출력
      - name: Display review results
        if: env.EVENT_TYPE == 'push'
        run: cat review_result.txt