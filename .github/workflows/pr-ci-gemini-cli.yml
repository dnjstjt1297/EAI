name: PR CI & Gemini Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Diff ì¶”ì¶œì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ===== í”„ë¡œì íŠ¸ ì„¤ì • íŒŒì¼ ìƒì„± =====
      - name: Create config.properties
        run: |
          mkdir -p src/main/resources src/test/resources
          cat <<EOF > src/main/resources/config.properties
          applicant.key=${{ secrets.APPLICANT_KEY }}
          db.driver=${{ secrets.DB_DRIVER }}
          db.url=${{ secrets.DB_URL }}
          db.user=${{ secrets.DB_USER }}
          db.password=${{ secrets.DB_PASSWORD }}
          sftp.host=${{ secrets.SFTP_HOST }}
          sftp.port=${{ secrets.SFTP_PORT }}
          sftp.username=${{ secrets.SFTP_USERNAME }}
          sftp.password=${{ secrets.SFTP_PASSWORD }}
          sftp.filepath=${{ secrets.SFTP_FILENAME }}
          EOF

          cat <<EOF > src/test/resources/config.properties
          applicant.key=${{ secrets.T_APPLICANT_KEY }}
          db.driver=${{ secrets.T_DB_DRIVER }}
          db.url=${{ secrets.T_DB_URL }}
          db.user=${{ secrets.T_DB_USER }}
          db.password=${{ secrets.T_DB_PASSWORD }}
          sftp.host=${{ secrets.T_SFTP_HOST }}
          sftp.port=${{ secrets.T_SFTP_PORT }}
          sftp.username=${{ secrets.T_SFTP_USERNAME }}
          sftp.password=${{ secrets.T_SFTP_PASSWORD }}
          sftp.filepath=${{ secrets.T_SFTP_FILENAME }}
          EOF

      # ===== ì»´íŒŒì¼ ë° í…ŒìŠ¤íŠ¸ =====
      - name: Compile
        run: |
          mkdir -p out
          javac -encoding UTF-8 -cp "lib/*" -d out \
            $(find src/main/java src/test/java -name "*.java")

      - name: Run tests
        id: test
        run: |
          set +e
          java -jar lib/junit-platform-console-standalone-1.8.1.jar \
            -cp out:lib/* \
            --scan-classpath > test.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          set -e

      # ===== Gemini AI ë¶„ì„ (ë¡œê·¸ + ì½”ë“œ ë¦¬ë·°) =====

      - name: Install Gemini AI
        run: |
          npm install @google/generative-ai

      - name: Gemini AI Review
        if: always()
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            
            // 1. í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì¤€ë¹„
            let testLog = "ë¡œê·¸ ì—†ìŒ";
            if (fs.existsSync('test.log')) {
              const fullLog = fs.readFileSync('test.log', 'utf8');
              testLog = fullLog.split('\n').slice(-150).join('\n');
            }

            // 2. Git Diff ì¤€ë¹„
            let diff = "ë³€ê²½ ì‚¬í•­ ì—†ìŒ";
            try {
              diff = require('child_process').execSync('git diff origin/${{ github.base_ref }}...HEAD').toString();
            } catch (e) { console.log("Diff ì¶”ì¶œ ì‹¤íŒ¨:", e); }

            // 3. í”„ë¡¬í”„íŠ¸ ì‘ì„±
            const status = "${{ steps.test.outputs.exit_code }}" === "0" ? "ì„±ê³µ" : "ì‹¤íŒ¨";
            const prompt = `ë„ˆëŠ” êµ¬ê¸€ ì¶œì‹ ì˜ ì‹œë‹ˆì–´ ìë°” ë°±ì—”ë“œ ê°œë°œìì•¼. í˜„ì¬ PRì˜ CI ê²°ê³¼ëŠ” [${status}]ì•¼. 
            ì œê³µëœ ë¡œê·¸ì™€ ì½”ë“œë¥¼ ë¶„ì„í•´ì„œ 'í•œêµ­ì–´'ë¡œ ë¦¬ë·°í•´ì¤˜.

            1. í…ŒìŠ¤íŠ¸ ìš”ì•½: ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ì£¼ìš” ë¡œê·¸ ë¶„ì„.
            2. ì½”ë“œ ë¦¬ë·°: ë³€ê²½ëœ ì½”ë“œ(Diff) ì¤‘ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„(ì„±ëŠ¥, ë³´ì•ˆ, ê°€ë…ì„±).
            3. ì¢…í•© ì˜ê²¬: ì´ PRì´ ë©”ì¸ ë¸Œëœì¹˜ì— ë°˜ì˜ë˜ì–´ë„ ê´œì°®ì„ì§€ ì‹œë‹ˆì–´ì˜ ì‹œì„ ì—ì„œ ì¡°ì–¸.

            [í…ŒìŠ¤íŠ¸ ë¡œê·¸]
            ${testLog}

            [Git Diff]
            ${diff}`;

            // 4. Gemini í˜¸ì¶œ
            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            try {
              const result = await model.generateContent(prompt);
              const response = await result.response;
              core.exportVariable('AI_COMMENT', response.text());
            } catch (e) {
              core.exportVariable('AI_COMMENT', "AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }

      # ===== PRì— ìµœì¢… ì½”ë©˜íŠ¸ ë“±ë¡ =====
      - name: Post PR Comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "$AI_COMMENT" ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "### ğŸ¤– Gemini AI ì‹œë‹ˆì–´ ê°œë°œì ë¦¬ë·°
            $AI_COMMENT"
          fi