name: PR CI & Diff Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-ci:
    runs-on: ubuntu-latest

    steps:
      ################################
      # 1. 소스 체크아웃
      ################################
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ################################
      # 2. JDK 17 세팅
      ################################
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      ################################
      # 3. 빌드 & 테스트 (예시)
      ################################
      - name: Build & Test
        run: |
          echo "빌드/테스트 시작"
          # 예시 (필요한 명령으로 교체)
          # javac Main.java
          echo "빌드/테스트 완료"

      ################################
      # 4. PR diff 가져오기 (현재 브랜치 변경분만)
      ################################
      - name: Get PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR diff 다운로드 중..."

          curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "${{ github.event.pull_request.diff_url }}" \
            > pr.diff

          if [ ! -s pr.diff ]; then
            echo "⚠️ diff가 비어있음"
            echo "NO_DIFF=true" >> $GITHUB_ENV
          else
            echo "diff 크기:"
            wc -l pr.diff
            echo "NO_DIFF=false" >> $GITHUB_ENV
          fi

      ################################
      # 5. Gemini / LLM 리뷰 (diff 기준)
      ################################
      - name: Generate PR Review
        if: env.NO_DIFF == 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          DIFF_CONTENT=$(sed 's/"/\\"/g' pr.diff | sed ':a;N;$!ba;s/\n/\\n/g')

          echo "LLM 호출 중..."

          RESPONSE=$(curl -s https://YOUR_GEMINI_ENDPOINT \
            -H "Authorization: Bearer $GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"prompt\": \"Review the following git diff and give concise, actionable feedback:\\n$DIFF_CONTENT\"
            }")

          if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
            REVIEW_BODY="변경 사항은 있으나 자동 리뷰 결과를 생성하지 못했습니다."
          else
            REVIEW_BODY="$RESPONSE"
          fi

          echo "REVIEW_BODY<<EOF" >> $GITHUB_ENV
          echo "$REVIEW_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      ################################
      # 6. diff 없음 처리
      ################################
      - name: No diff fallback
        if: env.NO_DIFF == 'true'
        run: |
          echo "REVIEW_BODY<<EOF" >> $GITHUB_ENV
          echo "코드 변경 사항이 감지되지 않았습니다." >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      ################################
      # 7. PR 코멘트 작성
      ################################
      - name: Comment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{
              \"body\": \"## PR 리뷰 \n\n${REVIEW_BODY}\"
            }"