name: PR CI & Gemini Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**'

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-ci:
    runs-on: ubuntu-latest

    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      # ===== 1. Checkout =====
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ===== 2. Set up Java 17 =====
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ===== 3. Create config.properties =====
      - name: Create config.properties
        run: |
          mkdir -p src/main/resources src/test/resources
          cat <<EOF > src/main/resources/config.properties
          applicant.key=${{ secrets.APPLICANT_KEY }}
          db.driver=${{ secrets.DB_DRIVER }}
          db.url=${{ secrets.DB_URL }}
          db.user=${{ secrets.DB_USER }}
          db.password=${{ secrets.DB_PASSWORD }}
          sftp.host=${{ secrets.SFTP_HOST }}
          sftp.port=${{ secrets.SFTP_PORT }}
          sftp.username=${{ secrets.SFTP_USERNAME }}
          sftp.password=${{ secrets.SFTP_PASSWORD }}
          sftp.filepath=${{ secrets.SFTP_FILENAME }}
          EOF

          cat <<EOF > src/test/resources/config.properties
          applicant.key=${{ secrets.T_APPLICANT_KEY }}
          db.driver=${{ secrets.T_DB_DRIVER }}
          db.url=${{ secrets.T_DB_URL }}
          db.user=${{ secrets.T_DB_USER }}
          db.password=${{ secrets.T_DB_PASSWORD }}
          sftp.host=${{ secrets.T_SFTP_HOST }}
          sftp.port=${{ secrets.T_SFTP_PORT }}
          sftp.username=${{ secrets.T_SFTP_USERNAME }}
          sftp.password=${{ secrets.T_SFTP_PASSWORD }}
          sftp.filepath=${{ secrets.T_SFTP_FILENAME }}
          EOF

      # ===== 4. Compile & Test =====
      - name: Compile
        run: |
          mkdir -p out
          javac -encoding UTF-8 -cp "lib/*" -d out $(find src/main/java src/test/java -name "*.java")

      - name: Run tests
        id: test
        run: |
          set +e
          java -jar lib/junit-platform-console-standalone-1.8.1.jar -cp out:lib/* --scan-classpath > test.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          set -e

      # ===== 5. Install Gemini SDK =====
      - name: Install Gemini AI
        run: npm install @google/generative-ai

      # ===== 6. Get Git Diff =====
      - name: Get git diff
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            git fetch origin "${{ github.event.pull_request.base.ref }}"
            git fetch origin "${{ github.event.pull_request.head.ref }}"
            git diff --unified=0 "origin/${{ github.event.pull_request.base.ref }}"..."origin/${{ github.event.pull_request.head.ref }}" > diff.txt
          else
            git diff --unified=0 HEAD^ HEAD > diff.txt
          fi

      # ===== 7. Run Gemini Review =====
      - name: Run Gemini Review
        id: gemini_review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const { GoogleGenerativeAI } = require("@google/generative-ai");

            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); // 최신 모델

            const diff = fs.readFileSync("diff.txt", "utf8");

            let prompt = "";

            if (process.env.GITHUB_EVENT_NAME === "pull_request") {
              prompt = `
              Explain in Korean. You are a senior software engineer performing line-by-line code review on the given git diff.
              Identify issues in code quality, readability, performance, and security.
              Include exact line numbers based on the "@@ -x,y +x,y @@" format.
              Output in JSON format:
              [{"path":"{filepath}", "line":{line}, "text":"{review comment}", "side":"RIGHT"}]
              <git diff>${diff}</git diff>`;
            } else {
              prompt = `
              Explain in Korean. You are a senior software engineer performing high-level code review on the given git diff.
              Focus on maintainability, readability, performance, and security.
              Format your response in Markdown with clear headings per file.
              <git diff>${diff}</git diff>`;
            }

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            fs.writeFileSync("review_result.txt", text);
            console.log("Review results saved!");

      # ===== 8. Add PR Comments =====
      - name: Format PR Review Comments
        if: ${{ github.event_name == 'pull_request' }}
        id: store
        run: |
          echo "Validating review_result.txt..."
          # jq로 JSON 유효성 검사 및 한 줄 압축
          COMMENT=$(jq -c '.' review_result.txt)

          # GITHUB_OUTPUT에 안전하게 쓰기 (Here-doc 방식)
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add Pull Request Review Comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: nbaztec/add-pr-review-comment@v1.0.7
        with:
          # steps.store.outputs.comment에 저장된 JSON을 그대로 전달
          comments: ${{ steps.store.outputs.comment }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # ===== 9. Push 이벤트 리뷰 출력 =====
      - name: Display review results
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "===== Gemini Code Review Results ====="
          cat review_result.txt
          echo "======================================"

      - name: Upload review results artifact
        if: ${{ github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: gemini-code-review
          path: review_result.txt
